name: Publish

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      tags:
        description: 'Test scenario tags'
        required: true
        type: string

jobs:
  build:
    name: Publish for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-20.04
            files: |
              build/packages/MarkdownEdit*.deb
          - os: windows-latest
            files: |
              build/packages/MarkdownEdit*.exe
              build/packages/MarkdownEdit*.zip
#          - os: macos-latest
#            artifact_name: markdownedit.app
#            asset_name: markdownedit.app

    steps:
    - name: Checkout repo and submodules
      uses: actions/checkout@v3
      with:
        submodules: 'true'

    - if: contains( matrix.os, 'windows') || contains( matrix.os, 'macos')
      name: Install Qt on Windows and Mac
      uses: jurplel/install-qt-action@v3
      with:
        version: 6.2.4

#    - if: contains( matrix.os, 'windows') || contains( matrix.os, 'macos')
#      name: Install enchant on Windows and Mac
#      run:

    - if: contains( matrix.os, 'ubuntu')
      name: Install Qt and enchant-2 on Linux
      run: |
        sudo apt-get update
        sudo apt-get install -y qtbase5-dev qtdeclarative5-dev qttools5-dev libqt5svg5-dev libenchant-2-dev qt5ct dpkg-dev

    - name: Build
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        cmake --build . -j8
        cmake --build . --target=package -j3

      shell: bash

    - name: Upload package
      uses: actions/upload-artifact@v3
      with:
        path: ${{ matrix.files }}

  publish:
    name: Create release and upload files
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    strategy:
      fail-fast: false
    steps:
    - uses: actions/checkout@v3

    - name: Download files
      uses: actions/download-artifact@v3
      with:
        path: packages

    - name: Create changelog
      run: |
        git clone https://github.com/software-made-easy/MarkdownEdit old --depth=1
        grep -Fvx -f old/CHANGELOG.md CHANGELOG.md > ${{ github.workspace }}-CHANGELOG.txt

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        body_path: ${{ github.workspace }}-CHANGELOG.md
        generate_release_notes: true
        files: packages/*

